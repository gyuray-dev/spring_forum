<!DOCTYPE html>
<html th:replace="~{/baseLayout :: baseLayout(~{::title}, ~{::section}, ~{::link})}" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시글 조회</title>

    <!--  TOAST UI Editor Viewer CSS -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor-viewer.min.css" />
</head>

<body>
<section style="max-width: 800px; margin: auto;">

    <!-- 게시글 정보 -->
    <div class="container">
        <div class="row">
            <h2 class="h2 " th:text="${post.title}">글 제목</h2>
        </div>
        <div class="row text-end border-bottom mb-3 p-2 d-flex align-items-center">
            <p class="text-start col-md-10 col-sm-12 m-0">
                글번호: <span th:text="${post.id}">10</span>
                | 작성자: <span th:text="${post.user.name}">운영자</span>
                | 게시일: <span th:text="${#temporals.format(post.regDate, 'yyyy-MM-dd HH:mm:ss')}">2023.03.13</span>
                | 조회수: <span th:text="${post.view}">12</span>
            </p>
            <div class="col-md-2 col-sm-12">
                <div class="row">
                    <a th:href="@{/posts/{postId}/edit(postId = ${post.id})}"
                       class="col-md-6 col-sm-6 text-center fw-semibold">수정</a>
                    <a th:href="@{/posts/{postId}/delete(postId = ${post.id})}"
                       class="col-md-6 col-sm-6 text-center fw-semibold">삭제</a>
                </div>
            </div>
        </div>
        <div id="viewer"></div>
    </div>

    <!-- 목록으로 버튼 -->
    <div class="container d-flex">
        <a class="btn btn-outline-primary ms-auto mt-2 fw-bold"
           th:href="@{/posts?currentPage={currentPage}(currentPage=${currentPage})}">목록으로</a>
    </div>


    <!-- 댓글 -->
    <div class="container">
        <!-- 댓글 등록 -->
        <form th:action="@{/posts/{postId}/comments/add(postId = ${post.id})}" method="post">
                <textarea class="form-control w-100 mt-3" style="resize: none;" id="content" name="content" rows="3"
                          placeholder="댓글을 입력해주세요"></textarea>
            <div class="d-flex">
                <input class="btn btn-sm btn-primary ms-auto my-3 fw-bold" type="submit" value="댓글 등록"/>
            </div>
            <input type="hidden" name="userId" th:value="${post.user.id}"/>
            <input type="hidden" name="postId" th:value="${post.id}"/>
        </form>

        <!-- 댓글 목록 -->
        <ul class="list-group list-group-flush mb-3">
            <li class="row border-bottom my-2" th:each="commentListDTO : ${commentListDTOs}">
                <span class="col-6 col-md-2 fw-bold text-center" th:text="${commentListDTO.userName}">작성자</span>

                <span class="col-6 col-md-3 text-center text-secondary fw-normal fs-6"
                      th:text="${commentListDTO.formattedRegDate}">2023-03-14 18:52:00</span>

                <button th:onclick="|editComment(this, ${commentListDTO.commentId})|"
                        class="col-6 btn btn-sm col-md-1 ms-md-auto text-center comment-button">수정
                </button>

                <button th:onclick="|location='@{/posts/{postId}/comments/{commentId}/delete
                            (postId = ${post.id}, commentId = ${commentListDTO.commentId})}'|"
                        class="col-6 btn btn-sm col-md-1 text-center comment-button">삭제
                </button>

                <p th:text="${commentListDTO.content}" style="white-space: pre-wrap">댓글 내용</p>
            </li>
        </ul>

    </div>

    <!-- TODO - 빈 댓글 등록 방지 JS -->

    <!-- 댓글 수정 템플릿 -->
    <template>
        <form class="input-group col-12 col-6 mb-2" method="post">
                <textarea type="text" name="content" class="form-control" rows="3" style="resize: none"
                          aria-label="Recipient's username with two button addons"></textarea>
            <button class="btn btn-outline-secondary" type="button" onclick="submit()">완료</button>
            <button class="btn btn-outline-danger" type="button" onclick="cancelEdit(this)">취소</button>
            <input type="hidden" name="commentId"/>
        </form>
    </template>

    <!-- Toast Editor Viewer CDN -->
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-viewer.js"></script>

    <script th:inline="javascript">
            //edit comment
            function editComment(button, commentId) {
                let parent = button.parentElement;
                let contentEl = parent.lastElementChild;
                let content = contentEl.innerText;
                contentEl.style.display = 'none';


                let form = document.getElementsByTagName('template')[0].content.cloneNode(true).firstElementChild;
                let editTextarea = form.getElementsByTagName('textarea')[0];
                editTextarea.innerText = content;

                let hiddenInput = form.getElementsByTagName('input')[0];
                hiddenInput.value = commentId;

                form.action = '/posts/[[${postId}]]/comments/' + commentId + '/edit';

                parent.appendChild(form);

                let commentButtons = document.getElementsByClassName('comment-button');
                for (let button of commentButtons) {
                    button.style.pointerEvents = 'none';
                }
            }

            function cancelEdit(button) {
                let li = button.closest('li');
                li.getElementsByTagName('p')[0].style.display = '';
                li.getElementsByTagName('form')[0].remove();

                let commentButtons = document.getElementsByClassName('comment-button');
                for (let button of commentButtons) {
                    button.style.pointerEvents = '';
                }
            }

            // Toast UI Editor viewer
            const viewer = new toastui.Editor({
                el: document.querySelector('#viewer'),
                height: 'auto',
                initialValue: [[${post.content}]]
            });

    </script>

</section>


</body>

</html>